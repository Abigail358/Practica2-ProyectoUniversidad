<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Listado de Estudiantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4">🎓 Listado de Estudiantes</h2>

  <div class="text-end mb-3">
    <button class="btn btn-success" onclick="abrirModalCrear()">➕ Nuevo Estudiante</button>
  </div>

  <table class="table table-bordered table-hover shadow">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Número de Inscripción</th>
        <th>CI</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="estudiante-table-body">
      <!-- Aquí se insertarán los estudiantes con JavaScript -->
    </tbody>
  </table>
</div>

<!-- Modal para editar/crear estudiante -->
<div class="modal fade" id="estudianteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="estudianteForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Editar Estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="estudianteId">
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre</label>
          <input type="text" class="form-control" id="nombre" required>
        </div>
        <div class="mb-3">
          <label for="numeroInscripcion" class="form-label">Número de Inscripción</label>
          <input type="text" class="form-control" id="numeroInscripcion" required>
        </div>
        <div class="mb-3">
          <label for="ci" class="form-label">CI</label>
          <input type="text" class="form-control" id="ci" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const apiUrl = "/api/estudiantes";
  const tableBody = document.getElementById("estudiante-table-body");

  // Cargar estudiantes al iniciar
  fetch(apiUrl)
    .then(res => res.json())
    .then(estudiantes => {
      estudiantes.forEach(e => {
        const row = document.createElement("tr");
        row.id = `fila-${e.id}`;
        row.innerHTML = `
          <td>${e.id}</td>
          <td>${e.nombre}</td>
          <td>${e.numeroInscripcion}</td>
          <td>${e.ci}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editarEstudiante(${e.id})">✏️</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarEstudiante(${e.id})">🗑️</button>
          </td>`;
        tableBody.appendChild(row);
      });
    });

  function eliminarEstudiante(id) {
    if (confirm("¿Deseas eliminar este estudiante?")) {
      fetch(`${apiUrl}/${id}`, { method: 'DELETE' })
        .then(res => {
          if (res.ok) document.getElementById(`fila-${id}`).remove();
          else alert("Error al eliminar.");
        });
    }
  }

  function editarEstudiante(id) {
    fetch(`${apiUrl}/${id}`)
      .then(res => res.json())
      .then(e => {
        document.getElementById("modalTitle").textContent = "Editar Estudiante";
        document.getElementById("estudianteId").value = e.id;
        document.getElementById("nombre").value = e.nombre;
        document.getElementById("numeroInscripcion").value = e.numeroInscripcion;
        document.getElementById("ci").value = e.ci;
        new bootstrap.Modal(document.getElementById("estudianteModal")).show();
      });
  }

  function abrirModalCrear() {
    document.getElementById("modalTitle").textContent = "Nuevo Estudiante";
    document.getElementById("estudianteForm").reset();
    document.getElementById("estudianteId").value = "";
    new bootstrap.Modal(document.getElementById("estudianteModal")).show();
  }

  document.getElementById("estudianteForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const id = document.getElementById("estudianteId").value;
    const estudiante = {
      nombre: document.getElementById("nombre").value,
      numeroInscripcion: document.getElementById("numeroInscripcion").value,
      ci: document.getElementById("ci").value
    };

    const metodo = id ? "PUT" : "POST";
    const url = id ? `${apiUrl}/${id}` : apiUrl;

    fetch(url, {
      method: metodo,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(estudiante)
    }).then(res => {
      if (res.ok) {
        location.reload(); // recarga para mostrar los cambios
      } else {
        alert("Error al guardar estudiante.");
      }
    });
  });
</script>

</body>
</html>
